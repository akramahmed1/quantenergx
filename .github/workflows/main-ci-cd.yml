name: ğŸš€ Complete CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: 20
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

jobs:
  # Pre-checks and setup
  setup:
    name: ğŸ” Setup and Pre-checks
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      should-deploy: ${{ steps.should-deploy.outputs.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'package.json'
              - '.github/workflows/**'
            frontend:
              - 'frontend/**'
              - 'package.json'
              - '.github/workflows/**'

      - name: Should deploy?
        id: should-deploy
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  # Security and quality checks
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm ci --prefix backend
          npm ci --prefix frontend

      - name: Security audit
        run: |
          npm audit --audit-level=moderate || echo "::warning::Security vulnerabilities found"
          npm audit --audit-level=moderate --prefix backend || echo "::warning::Backend security issues found"
          npm audit --audit-level=moderate --prefix frontend || echo "::warning::Frontend security issues found"

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Backend build and test
  backend:
    name: ğŸ”§ Backend Build & Test
    runs-on: ubuntu-latest
    needs: [setup, security-scan]
    if: needs.setup.outputs.backend-changed == 'true' || github.event_name == 'push'
    defaults:
      run:
        working-directory: backend
    outputs:
      coverage: ${{ steps.test.outputs.coverage }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint || echo "::warning::Linting issues found"

      - name: Format check
        run: npm run format:check || echo "::warning::Formatting issues found"

      - name: Run tests with coverage
        id: test
        run: |
          npm run test:coverage
          COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct)")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

  # Frontend build and test
  frontend:
    name: ğŸ¨ Frontend Build & Test
    runs-on: ubuntu-latest
    needs: [setup, security-scan]
    if: needs.setup.outputs.frontend-changed == 'true' || github.event_name == 'push'
    defaults:
      run:
        working-directory: frontend
    outputs:
      coverage: ${{ steps.test.outputs.coverage }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: Type check
        run: npm run type-check

      - name: Build application
        run: npm run build
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://api.quantenergx.com' }}
          REACT_APP_ENVIRONMENT: production

      - name: Run tests with coverage
        id: test
        run: |
          npm run test:coverage
          COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct)")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        env:
          CI: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 3

  # Deploy to Vercel
  deploy-vercel:
    name: ğŸŒ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [setup, frontend]
    if: needs.setup.outputs.should-deploy == 'true' && (needs.setup.outputs.frontend-changed == 'true' || github.event_name == 'push')
    environment: production
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: frontend
          vercel-args: '--prod'

      - name: Health check
        run: |
          sleep 30
          curl -f "${{ steps.deploy.outputs.preview-url }}/health" || echo "::warning::Vercel health check failed"

  # Deploy to Render
  deploy-render:
    name: ğŸ”— Deploy to Render
    runs-on: ubuntu-latest
    needs: [setup, backend]
    if: needs.setup.outputs.should-deploy == 'true' && (needs.setup.outputs.backend-changed == 'true' || github.event_name == 'push')
    environment: production
    steps:
      - name: Deploy to Render
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json"

      - name: Wait and health check
        run: |
          sleep 60
          for i in {1..5}; do
            if curl -f "${{ secrets.RENDER_APP_URL }}/health"; then
              echo "âœ… Render health check passed"
              exit 0
            fi
            echo "â³ Health check attempt $i failed, retrying in 30s..."
            sleep 30
          done
          echo "::error::Render health check failed after 5 attempts"
          exit 1

  # Deploy to Railway
  deploy-railway:
    name: ğŸš‚ Deploy to Railway
    runs-on: ubuntu-latest
    needs: [setup, backend]
    if: needs.setup.outputs.should-deploy == 'true' && (needs.setup.outputs.backend-changed == 'true' || github.event_name == 'push')
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        run: |
          railway login --token ${{ secrets.RAILWAY_TOKEN }}
          railway up --service backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait and health check
        run: |
          sleep 60
          for i in {1..5}; do
            if curl -f "${{ secrets.RAILWAY_APP_URL }}/health"; then
              echo "âœ… Railway health check passed"
              exit 0
            fi
            echo "â³ Health check attempt $i failed, retrying in 30s..."
            sleep 30
          done
          echo "::error::Railway health check failed after 5 attempts"
          exit 1

  # Final status and reporting
  status-report:
    name: ğŸ“Š Status Report
    runs-on: ubuntu-latest
    needs: [backend, frontend, deploy-vercel, deploy-render, deploy-railway]
    if: always()
    steps:
      - name: Generate deployment report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const backendCoverage = '${{ needs.backend.outputs.coverage || 'N/A' }}';
            const frontendCoverage = '${{ needs.frontend.outputs.coverage || 'N/A' }}';
            const vercelUrl = '${{ needs.deploy-vercel.outputs.url || 'N/A' }}';
            
            const deploymentStatus = `
            ## ğŸš€ Deployment Status Report
            
            ### ğŸ§ª Test Coverage
            | Component | Coverage |
            |-----------|----------|
            | Backend | ${backendCoverage}% |
            | Frontend | ${frontendCoverage}% |
            
            ### ğŸŒ Deployment Status
            | Platform | Status | URL |
            |----------|--------|-----|
            | Vercel | ${{ needs.deploy-vercel.result || 'skipped' }} | ${vercelUrl} |
            | Render | ${{ needs.deploy-render.result || 'skipped' }} | ${{ secrets.RENDER_APP_URL || 'N/A' }} |
            | Railway | ${{ needs.deploy-railway.result || 'skipped' }} | ${{ secrets.RAILWAY_APP_URL || 'N/A' }} |
            
            ### ğŸ“‹ Build Status
            - **Backend**: ${{ needs.backend.result || 'skipped' }}
            - **Frontend**: ${{ needs.frontend.result || 'skipped' }}
            
            All systems operational! ğŸ‰
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: deploymentStatus
            });

      - name: Slack notification
        if: needs.setup.outputs.should-deploy == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            ğŸš€ Deployment completed for ${{ github.ref }}
            ğŸ“Š Backend Coverage: ${{ needs.backend.outputs.coverage || 'N/A' }}%
            ğŸ“Š Frontend Coverage: ${{ needs.frontend.outputs.coverage || 'N/A' }}%
            ğŸŒ Vercel: ${{ needs.deploy-vercel.result || 'skipped' }}
            ğŸ”— Render: ${{ needs.deploy-render.result || 'skipped' }}
            ğŸš‚ Railway: ${{ needs.deploy-railway.result || 'skipped' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}